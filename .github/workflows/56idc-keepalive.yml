name: 56idc VPS Keep Alive

on:
  schedule:
    - cron: '10 2 * * 1'   # ÊØèÂë®‰∏Ä 02:10 UTC = Âåó‰∫¨Êó∂Èó¥ 10:10
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser

      - name: Login and screenshot
        run: |
          cat << 'EOF' > login.js
          const puppeteer = require('puppeteer');

          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();
            await page.goto('https://56idc.net/login', { waitUntil: 'networkidle2' });

            await page.type('input[name="username"]', process.env.IDC_USERNAME);
            await page.type('input[name="password"]', process.env.IDC_PASSWORD);
            await page.click('input[name="rememberme"]');

            await Promise.all([
              page.click('button[type="submit"]'),
              page.waitForNavigation({ waitUntil: 'networkidle2' })
            ]);

            await page.goto('https://56idc.net/clientarea', { waitUntil: 'networkidle2' });

            await page.screenshot({ path: 'login-success.png', fullPage: true });

            await browser.close();
          })();
          EOF

          npm init -y
          npm install puppeteer
          node login.js
        env:
          IDC_USERNAME: ${{ secrets.IDC_USERNAME }}
          IDC_PASSWORD: ${{ secrets.IDC_PASSWORD }}

      - name: Telegram Notify with Screenshot
        if: success()
        run: |
          TIME=$(date '+%Y-%m-%d %H:%M:%S (UTC)')
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendPhoto \
            -F chat_id=${{ secrets.TG_CHAT_ID }} \
            -F photo=@login-success.png \
            -F caption="‚úÖ 56idc VPS ‰øùÊ¥ªÊàêÂäü\nüïí Êó∂Èó¥Ôºö$TIME"

      - name: Telegram Notify Failure
        if: failure()
        run: |
          TIME=$(date '+%Y-%m-%d %H:%M:%S (UTC)')
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="‚ùå 56idc VPS ‰øùÊ¥ªÂ§±Ë¥•\nüïí Êó∂Èó¥Ôºö$TIME"
