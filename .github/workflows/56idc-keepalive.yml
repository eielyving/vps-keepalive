name: 56idc VPS Keep Alive

on:
  schedule:
    - cron: '10 2 * * 1'   # æ¯å‘¨ä¸€ 02:10 UTC = åŒ—äº¬æ—¶é—´ 10:10
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest

    steps:
      - name: Login to 56idc via curl
        run: |
          echo "è·å–ç™»å½•é¡µé¢"

          LOGIN_PAGE=$(curl -s -c cookies.txt https://56idc.net/login)
          TOKEN=$(echo "$LOGIN_PAGE" | grep -oP 'name="token"\s+value="\K[^"]+')

          if [ -z "$TOKEN" ]; then
            echo "è·å– token å¤±è´¥"
            exit 1
          fi

          echo "æäº¤ç™»å½•è¯·æ±‚"

          curl -s -b cookies.txt -c cookies.txt -X POST https://56idc.net/login \
            -d "token=$TOKEN" \
            -d "username=${{ secrets.IDC_USERNAME }}" \
            -d "password=${{ secrets.IDC_PASSWORD }}" \
            -d "rememberme=on"

          echo "éªŒè¯ç™»å½•çŠ¶æ€"

          HTTP_CODE=$(curl -b cookies.txt -o /dev/null -s -w "%{http_code}" https://56idc.net/clientarea)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "ç™»å½•å¤±è´¥"
            exit 1
          fi

      - name: Telegram Notify Result
        if: always()
        run: |
          TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')

          if [ "${{ job.status }}" = "success" ]; then
            MSG="âœ… 56idc VPS ä¿æ´»æˆåŠŸ\nğŸ•’ åŒ—äº¬æ—¶é—´ï¼š$TIME"
          else
            MSG="âŒ 56idc VPS ä¿æ´»å¤±è´¥\nğŸ•’ åŒ—äº¬æ—¶é—´ï¼š$TIME"
          fi

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$MSG"
